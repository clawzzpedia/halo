<script>
    const socket = io({ path: '/socket.io/', transports: ['websocket', 'polling'] });
    let username = 'Anon' + Math.floor(Math.random() * 1000);
    let chatCleared = false;
    
    // DETECT LAYOUT
    const isMobile = window.innerWidth <= 768;
    const desktopElements = {
        status: document.getElementById('desktopStatus'),
        userCount: document.getElementById('desktopUserCount'),
        messages: document.getElementById('desktopMessages'),
        input: document.getElementById('desktopInput'),
        sendBtn: document.getElementById('desktopSendBtn'),
        imageInput: document.getElementById('desktopImageInput')
    };
    const mobileElements = {
        status: document.getElementById('mobileStatus'),
        userCount: document.getElementById('mobileUserCount'),
        messages: document.getElementById('mobileMessages'),
        input: document.getElementById('mobileInput'),
        sendBtn: document.getElementById('mobileSendBtn'),
        themeToggle: document.getElementById('mobileThemeToggle'),
        clearBtn: document.getElementById('mobileClearBtn'),
        imageInput: document.getElementById('mobileImageInput')
    };
    
    const elements = isMobile ? mobileElements : desktopElements;
    
    // Dark mode
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.replace('light', 'dark');
        if (isMobile && mobileElements.themeToggle) mobileElements.themeToggle.textContent = 'â˜€ï¸';
    }
    
    // Theme toggle mobile
    if (mobileElements.themeToggle) {
        mobileElements.themeToggle.onclick = () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            mobileElements.themeToggle.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
        };
    }
    
    // Clear chat
    if (mobileElements.clearBtn) {
        mobileElements.clearBtn.onclick = () => {
            if (confirm('Hapus chat di layar kamu?')) {
                elements.messages.innerHTML = '';
                chatCleared = true;
                mobileElements.clearBtn.style.opacity = '0.5';
            }
        };
    }
    
    // Input resize
    elements.input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 140) + 'px';
        elements.sendBtn.classList.toggle('enabled', this.value.trim());
    });
    
    // Socket events
    socket.on('connect', () => {
        elements.status.textContent = 'ðŸŸ¢ Online';
        if (!isMobile) desktopElements.status2.textContent = 'ðŸŸ¢ Online';
    });
    socket.on('disconnect', () => elements.status.textContent = 'ðŸ”´ Offline');
    socket.on('userCount', (count) => {
        elements.userCount.textContent = count;
        if (!isMobile) desktopElements.userCount.textContent = count;
    });
    
    socket.on('chatHistory', (history) => {
        if (!chatCleared) {
            elements.messages.innerHTML = '';
            history.forEach(msg => {
                if (msg.type === 'text') addMessage(msg.username, msg.message, msg.timestamp);
                else if (msg.type === 'image') addImageMessage(msg.username, msg.image, msg.timestamp);
            });
        }
    });
    
    socket.on('message', (data) => {
        if (!chatCleared) addMessage(data.username, data.message, data.timestamp);
    });
    
    socket.on('imageMessage', (data) => {
        if (!chatCleared) addImageMessage(data.username, data.image, data.timestamp);
    });
    
    function sendMessage() {
        const text = elements.input.value.trim();
        if (text && socket.connected) {
            socket.emit('chatMessage', { username, message: text });
            elements.input.value = '';
            elements.input.style.height = 'auto';
            elements.sendBtn.classList.remove('enabled');
        }
    }
    
    elements.sendBtn.onclick = sendMessage;
    elements.input.onkeypress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    };
    
    // Image upload
    elements.imageInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const formData = new FormData();
            formData.append('image', file);
            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                socket.emit('imageMessage', { username, image: data.image });
            } catch (err) {
                alert('Gagal upload foto');
            }
        }
        elements.imageInput.value = '';
    };
    
    // Message functions
    function addMessage(user, message, time) {
        const div = document.createElement('div');
        const hue = Math.floor(Math.random() * 360);
        const avatar = user.charAt(0).toUpperCase();
        const isMobileLayout = window.innerWidth <= 768;
        
        if (isMobileLayout) {
            div.className = 'mobile-message';
            div.innerHTML = `
                <div class="mobile-avatar" style="background:hsl(${hue},70%,50%)">${avatar}</div>
                <div class="mobile-bubble">
                    <div class="mobile-meta">
                        <span class="mobile-username">${user}</span>
                        <span class="mobile-timestamp">${time}</span>
                    </div>
                    <div class="mobile-text">${message}</div>
                </div>
            `;
        } else {
            div.className = 'message-row';
            div.innerHTML = `
                <div class="message-avatar" style="background:hsl(${hue},70%,50%)">${avatar}</div>
                <div class="message-bubble">
                    <div class="message-meta">
                        <span class="username">${user}</span>
                        <span class="timestamp">${time}</span>
                    </div>
                    <div class="message-text">${message}</div>
                </div>
            `;
        }
        
        elements.messages.appendChild(div);
        elements.messages.scrollTop = elements.messages.scrollHeight;
    }
    
    function addImageMessage(user, image, time) {
        const div = document.createElement('div');
        const hue = Math.floor(Math.random() * 360);
        const avatar = user.charAt(0).toUpperCase();
        const isMobileLayout = window.innerWidth <= 768;
        
        if (isMobileLayout) {
            div.className = 'mobile-message';
            div.innerHTML = `
                <div class="mobile-avatar" style="background:hsl(${hue},70%,50%)">${avatar}</div>
                <div class="mobile-bubble">
                    <div class="mobile-meta">
                        <span class="mobile-username">${user}</span>
                        <span class="mobile-timestamp">${time}</span>
                    </div>
                    <img src="${image}" class="mobile-image">
                </div>
            `;
        } else {
            div.className = 'message-row';
            div.innerHTML = `
                <div class="message-avatar" style="background:hsl(${hue},70%,50%)">${avatar}</div>
                <div class="message-bubble">
                    <div class="message-meta">
                        <span class="username">${user}</span>
                        <span class="timestamp">${time}</span>
                    </div>
                    <img src="${image}" class="message-image">
                </div>
            `;
        }
        
        elements.messages.appendChild(div);
        elements.messages.scrollTop = elements.messages.scrollHeight;
    }
    
    // Resize handler
    window.addEventListener('resize', () => {
        location.reload(); // Simple reload on layout change
    });
</script>
</body>
</html>
